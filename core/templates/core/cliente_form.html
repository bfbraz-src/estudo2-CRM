{% extends 'core/base.html' %}

{% block title %}{{ title }} - Sistema de Atendimentos{% endblock %}

{% block content %}
<div class="main-content animate-fade-in">
    <div class="page-header">
        <h1><i class="fas fa-user-plus me-3"></i>{{ title }}</h1>
        <p>Preencha os dados do cliente</p>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user me-2"></i>Dados do Cliente
                </div>
                <div class="card-body">
                    {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>Erro no formulário. Verifique os dados informados:</strong>
                                <ul class="mb-0">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ field|capfirst }}: {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    <form method="post" id="clienteForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="id_nome" class="form-label">Nome Completo *</label>
                                {{ form.nome }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_email" class="form-label">E-mail *</label>
                                {{ form.email }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_telefone" class="form-label">Telefone *</label>
                                {{ form.telefone }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_cpf" class="form-label">CPF *</label>
                                {{ form.cpf }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_cep" class="form-label">CEP *</label>
                                {{ form.cep }}
                                <small class="form-text text-muted">O endereço será preenchido automaticamente</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="id_logradouro" class="form-label">Logradouro *</label>
                                {{ form.logradouro }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="id_numero" class="form-label">Número *</label>
                                {{ form.numero }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_complemento" class="form-label">Complemento</label>
                                {{ form.complemento }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_bairro" class="form-label">Bairro *</label>
                                {{ form.bairro }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="id_cidade" class="form-label">Cidade *</label>
                                {{ form.cidade }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="id_estado" class="form-label">Estado *</label>
                                {{ form.estado }}
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>Salvar Cliente
                                    </button>
                                    <a href="{% url 'cliente_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
<script>
$(document).ready(function() {
    // Busca CEP quando o usuário sair do campo
    $('#id_cep').on('blur', function() {
        const cep = $(this).val();
        if (cep) {
            buscarCEP(cep);
        }
    });

    //document.addEventListener('DOMContentLoaded', function() {
    //    Inputmask('999.999.999-99').mask('#id_cpf');
    //});


    // Validação do formulário
    $('#clienteForm').on('submit', function(e) {
        if (!validateForm($(this))) {
            e.preventDefault();
        }
    });

    // Validação em tempo real
    $('input[required]').on('blur', function() {
        const field = $(this);
        const value = field.val().trim();
        
        if (!value) {
            showFieldError(field, 'Este campo é obrigatório');
        } else {
            clearFieldError(field);
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
    
        // Função para aplicar máscara
        function applyMask(input, mask) {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                let maskedValue = '';
                let maskIndex = 0;
            
                for (let i = 0; i < value.length && maskIndex < mask.length; i++) {
                    while (maskIndex < mask.length && mask[maskIndex] !== '0') {
                        maskedValue += mask[maskIndex];
                        maskIndex++;
                    }
                    if (maskIndex < mask.length) {
                        maskedValue += value[i];
                        maskIndex++;
                    }
                }
            
                e.target.value = maskedValue;
            });
        }
    
        // Aplicar máscaras aos campos
        const telefoneInput = document.querySelector('input[data-mask="(00) 00000-0000"]');
        if (telefoneInput) {
            applyMask(telefoneInput, '(00) 00000-0000');
        }
    
        const cpfInput = document.querySelector('input[data-mask="000.000.000-00"]');
        if (cpfInput) {
            applyMask(cpfInput, '000.000.000-00');
        }
    
        const cepInput = document.querySelector('input[data-mask="00000-000"]');
        if (cepInput) {
            applyMask(cepInput, '00000-000');
        
            // Buscar endereço pelo CEP
            cepInput.addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    buscarCEP(cep);
                }
            });
        }
    
        // Validação em tempo real
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const errors = [];
                
                // Validar CPF
                const cpf = document.getElementById('id_cpf').value.replace(/\D/g, '');
                if (cpf && !validarCPF(cpf)) {
                    errors.push('CPF inválido');
                }
            
                // Validar telefone
                const telefone = document.getElementById('id_telefone').value.replace(/\D/g, '');
                if (telefone && (telefone.length < 10 || telefone.length > 11)) {
                    errors.push('Telefone deve ter 10 ou 11 dígitos');
                }
            
                // Validar CEP
                const cep = document.getElementById('id_cep').value.replace(/\D/g, '');
                if (cep && cep.length !== 8) {
                    errors.push('CEP deve ter 8 dígitos');
                }
            
                if (errors.length > 0) {
                    e.preventDefault();
                    alert('Erros encontrados:\n' + errors.join('\n'));
                }
            });
        }
    });

    // Função para validar CPF no JavaScript
    function validarCPF(cpf) {
        if (cpf.length !== 11 || cpf === cpf[0].repeat(11)) {
            return false;
        }
    
        // Primeiro dígito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
            soma += parseInt(cpf[i]) * (10 - i);
        }   
        let digito1 = 11 - (soma % 11);
        if (digito1 >= 10) digito1 = 0;
    
        if (parseInt(cpf[9]) !== digito1) return false;
    
        // Segundo dígito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
            soma += parseInt(cpf[i]) * (11 - i);
        }
        let digito2 = 11 - (soma % 11);
        if (digito2 >= 10) digito2 = 0;
    
        return parseInt(cpf[10]) === digito2;
    }

    // Função para buscar CEP (via ViaCEP)
    async function buscarCEP(cep) {
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
        
            if (!data.erro) {
                document.getElementById('id_logradouro').value = data.logradouro || '';
                document.getElementById('id_bairro').value = data.bairro || '';
                document.getElementById('id_cidade').value = data.localidade || '';
            
                // Selecionar o estado
                const estadoSelect = document.getElementById('id_estado');
                if (estadoSelect && data.uf) {
                    estadoSelect.value = data.uf;
                }
            
                // Focar no campo número após preencher o endereço
                document.getElementById('id_numero').focus();
            } else {
                alert('CEP não encontrado');
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
        }
    }
});
</script>
{% endblock %}